## 5. Лемма: SAT $\le_m^p$ 3SAT (полное доказательство)

Будем кодировать CNF‑формулу $F$ как конъюнкцию клауз (дизъюнктов) из литералов. Литерал — переменная $x_i$ или её отрицание $\neg x_i$.

**Lean‑скелет:** синтаксические определения CNF/3CNF и SAT заданы в `formal/PvNP/SAT.lean` (кодирование в битстроки пока не формализовано).
Определение преобразования SAT→3SAT задано в `formal/PvNP/ReductionsSAT.lean`.
Временная формальная заглушка корректности: `formal/External/NPCompleteness.lean` (ASSUMPTION).

**Теорема 5.1.** Существует полиномиально вычислимая функция $T$, которая
по CNF‑формуле $F$ строит 3CNF‑формулу $T(F)$ такую, что $F$ выполнима
тогда и только тогда, когда $T(F)$ выполнима.

*Конструкция.* Пусть $F=\bigwedge_{j=1}^m C_j$, где $C_j$ — дизъюнкт из $k_j$ литералов.

1) Если $k_j=1$, то $C_j=(\ell_1)$ заменяем на $(\ell_1\lor\ell_1\lor\ell_1)$.

2) Если $k_j=2$, то $C_j=(\ell_1\lor\ell_2)$ заменяем на $(\ell_1\lor\ell_2\lor\ell_2)$.

3) Если $k_j=3$, оставляем как есть.

4) Если $k_j>3$ и $C_j=(\ell_1\lor\ell_2\lor\cdots\lor\ell_{k_j})$, вводим
новые переменные $y_1,\dots,y_{k_j-3}$ и заменяем $C_j$
на конъюнкцию $k_j-2$ трёхлитеральных клауз:

$$(\ell_1\lor\ell_2\lor y_1)\ \wedge\ (\neg y_1\lor\ell_3\lor y_2)\ \wedge\ \cdots
(\neg y_{k_j-4}\lor\ell_{k_j-2}\lor y_{k_j-3})
\ \wedge\ (\neg y_{k_j-3}\lor\ell_{k_j-1}\lor\ell_{k_j}).$$

Определим $T(F)$ как конъюнкцию преобразованных клауз для всех $j$.

*Корректность (эквисатисфайбилити).* Достаточно проверить для каждой клаузы $C_j$.

- Случаи $k_j\le 3$ очевидно сохраняют выполнимость: замена добавляет дубликаты литералов.

- Пусть $k_j>3$. Обозначим полученную цепочку клауз как $D_1\wedge\cdots\wedge D_{k_j-2}$.

($\Rightarrow$) Пусть $C_j$ истинна на присваивании $x$, и $\ell_t$ истинна.
Если $t\le 2$, положим все $y_i=\mathrm{false}$.
Если $t>2$, зададим $y_i=\mathrm{true}$ для $i< t-2$ и $y_i=\mathrm{false}$ для $i\ge t-2$.
Тогда в каждой $D_i$ истинен хотя бы один литерал; цепочка выполнима.

($\Leftarrow$) Пусть цепочка выполнима, но все $\ell_1,\dots,\ell_{k_j}$ ложны.
Тогда из $D_1=(\ell_1\lor\ell_2\lor y_1)$ следует $y_1=\mathrm{true}$,
из $D_2=(\neg y_1\lor\ell_3\lor y_2)$ — $y_2=\mathrm{true}$, и так далее,
получаем $y_{k_j-3}=\mathrm{true}$.
Последняя клауза $D_{k_j-2}$ становится ложной — противоречие.
Значит хотя бы один $\ell_t$ истинен, то есть $C_j$ истинна.

Таким образом, $C_j$ выполнима $\iff$ соответствующая 3CNF‑замена выполнима.
По конъюнкции по всем $j$ получаем $F$ выполнима $\iff T(F)$ выполнима.

*Сложность.* Размер увеличивается линейно по суммарной длине клауз
(для клаузы длины $k$ создаётся $k-2$ клауз и $k-3$ новых переменных).
Значит $T$ вычислима за полиномиальное время.

$\square$
